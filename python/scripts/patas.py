#!/usr/bin/python
# -*- coding: utf-8 -*-

from datetime import datetime
import math
import os
import yaml

class Point:
 def __init__(self, x, y):
  self.x = x
  self.y = y
 def __repr__(self):
  return f'Point(x={self.x}, y={self.y})'

with open('../yaml/dimensiones.yaml', 'r', encoding='utf-8') as f:
 dimensions = yaml.safe_load(f).get('dimensions', {})

show_pieces = True # show panel and G60 ... para tener una idea ...
#show_pieces = False

r_metal = dimensions['panel_metal_rs']
r_bigxx = dimensions['foot_stand_rb']
r_small = dimensions['foot_stand_rx']
a_optim = dimensions['foot_stand_ax']

struct_holes_orbit = dimensions['panels']['strut_orbit_radius'] / 10.0
struct_holes_radius = dimensions['panels']['strut_hole_diameter'] / 20.0

pp_xy = dimensions['panel_plexi_xy']

outstand = dimensions['foot_outstand']
backlevel = 1 # feet backlevel

def calc_px_py(x,y,r,a):
 ang = math.radians(a)
 px = r * math.cos(ang) + x
 py = r * math.sin(ang) + y
 return [px,py]

def float_shorten(f):
 ff = f'{f:.3f}'.rstrip('0').rstrip('.')
 if ff.startswith('0.'): ff = ff[1:]
 if ff.startswith('-0.'): ff = '-' + ff[2:]
 return ff

def circle_path(cx, cy, r): # circle as two 180Â° arcs for compound path
 return f'M {float_shorten(cx - r)} {float_shorten(cy)} a {float_shorten(r)} {float_shorten(r)} 0 1 0 {float_shorten(2*r)} 0 a {float_shorten(r)} {float_shorten(r)} 0 1 0 {float_shorten(-2*r)} 0 Z '

def add_struct_holes():
 outtxt = ''
 an = math.radians(45)
 px = struct_holes_orbit * math.cos(an)
 py = struct_holes_orbit * math.sin(an)
 outtxt += circle_path(px, py, struct_holes_radius)
 an = math.radians(135)
 px = struct_holes_orbit * math.cos(an)
 py = struct_holes_orbit * math.sin(an)
 outtxt += circle_path(px, py, struct_holes_radius)
 return outtxt

def build_svg():
 P0 = calc_px_py(-50, 50,r_metal,180)
 P1 = calc_px_py(-50, 50,r_metal,360 - a_optim)
 P2 = calc_px_py( 50, 50,r_metal,180 + a_optim)
 P3 = calc_px_py( 50, 50,r_metal,  0)

 P00 = float_shorten(P0[0])
 P01 = float_shorten(P0[1])
 P10 = float_shorten(P1[0])
 P11 = float_shorten(P1[1])
 P20 = float_shorten(P2[0])
 P21 = float_shorten(P2[1])
 P30 = float_shorten(P3[0])
 P31 = float_shorten(P3[1])

 p4 = calc_px_py( 59, 59,r_small,  0)
 p5 = calc_px_py( 59, 59,r_small, 90)
 p6 = calc_px_py(-59, 59,r_small, 90)
 p7 = calc_px_py(-59, 59,r_small,180)

 p40 = float_shorten(p4[0])
 p41 = float_shorten(60 - r_small + outstand)
 p50 = float_shorten(P3[0] - r_small)
 p51 = float_shorten(60 + outstand)
 p60 = float_shorten(P0[0] + r_small)
 p61 = float_shorten(p6[1] + outstand)
 p70 = float_shorten(P0[0])
 p71 = float_shorten(60 - r_small + outstand)

 A = Point(0,0)
 M = Point(0,pp_xy)
 B = Point(0,0)
 C = Point(0,0)
 N = Point(0,pp_xy)
 D = Point(0,0)

 M.x = calc_px_py( 50, 50,r_metal,180)[0]
 N.x = calc_px_py(-50, 50,r_metal,  0)[0]

 rr = outstand
 A.x = M.x + rr
 A.y = M.y + rr
 B.x = M.x - rr
 B.y = M.y - rr
 C.x = N.x + rr
 C.y = N.y - rr
 D.x = N.x - rr
 D.y = N.y + rr

 print(M)
 print(N)

 P0 = calc_px_py(-50, 50,r_metal,180)
 P1 = calc_px_py(-50, 50,r_metal,360 - a_optim)
 P2 = calc_px_py( 50, 50,r_metal,180 + a_optim)
 P3 = calc_px_py( 50, 50,r_metal,  0)

 dd = f'L {A.x} {A.y} A {rr} {rr} 0 0 1 {M.x} {M.y} ' \
    + f'              A {rr} {rr} 0 0 0 {B.x} {B.y} ' \
    + f'L {C.x} {C.y} A {rr} {rr} 0 0 0 {N.x} {N.y} ' \
    + f'              A {rr} {rr} 0 0 1 {D.x} {D.y} '
 # dd = ''

 pata = f'M {P00} {P01} A {r_metal} {r_metal} 0 0 1 {P10} {P11} A {r_bigxx} {r_bigxx} 0 0 0 {P20} {P21} ' \
                       + f'A {r_metal} {r_metal} 0 0 1 {P30} {P31} V {p41} A {r_small} {r_small} 0 0 1 {p50} {p51} ' \
                       + f'{dd}' \
                       + f'L {p60} {p61} ' \
                       + f'A {r_small} {r_small} 0 0 1 {p70} {p71} Z'
 pata += add_struct_holes()
 timestamp = datetime.now().strftime('%Y.%m.%d %H:%M:%S')
 svg = f'''<?xml version="1.0" encoding="UTF-8" ?><!-- generated with ../scripts/{os.path.splitext(os.path.basename(__file__))[0]}.py --><!-- SZT {timestamp} -->
<svg xmlns="http://www.w3.org/2000/svg" width="138cm" height="138cm" viewBox="-69 -69 138 138">
<defs><style type="text/css">
 #pata {{ fill:#204060; fill-opacity:.7; fill-rule:evenodd; stroke:none; }}
 #bgnd {{ fill:white; }}
</style></defs>
<rect id="bgnd" height="138" width="138" x="-69" y="-69" />
{'<path id="auxx" style="fill:rgba(30,60,90,.2); fill-rule:evenodd; stroke:none;" d="M -2.837 54.147 A .5 .5 0 0 1 -2.386 54.669 L -2.499 57.241 L -1.999 57.26 A 2.097 2.097 0 0 1 1.999 57.26 L 2.499 57.241 L 2.386 54.669 A .5 .5 0 0 1 2.837 54.147 A .5 .5 0 0 1 3.34 54.619 L 3.497 57.188 L 3.996 57.156 A 2.097 2.097 0 0 1 7.974 56.738 L 8.468 56.666 L 8.088 54.12 A .5 .5 0 0 1 8.482 53.553 A .5 .5 0 0 1 9.031 53.97 L 9.456 56.51 L 9.949 56.425 A 2.097 2.097 0 0 1 13.861 55.593 L 14.345 55.47 L 13.701 52.978 A .5 .5 0 0 1 14.033 52.373 A .5 .5 0 0 1 14.623 52.731 L 15.311 55.211 L 15.792 55.076 A 2.097 2.097 0 0 1 19.596 53.84 L 20.065 53.667 L 19.163 51.255 A .5 .5 0 0 1 19.431 50.619 A .5 .5 0 0 1 20.055 50.913 L 20.998 53.308 L 21.463 53.123 A 2.097 2.097 0 0 1 25.116 51.497 L 25.565 51.275 L 24.416 48.972 A .5 .5 0 0 1 24.615 48.311 A .5 .5 0 0 1 25.267 48.538 L 26.456 50.821 L 26.898 50.589 A 2.097 2.097 0 0 1 30.362 48.589 L 30.784 48.322 L 29.401 46.151 A .5 .5 0 0 1 29.531 45.473 A .5 .5 0 0 1 30.202 45.631 L 31.623 47.778 L 32.039 47.5 A 2.097 2.097 0 0 1 35.274 45.149 L 35.667 44.84 L 34.064 42.825 A .5 .5 0 0 1 34.122 42.137 A .5 .5 0 0 1 34.807 42.224 L 36.444 44.21 L 36.829 43.891 A 2.097 2.097 0 0 1 39.8 41.215 L 40.159 40.866 L 38.354 39.03 A .5 .5 0 0 1 38.34 38.34 A .5 .5 0 0 1 39.03 38.354 L 40.866 40.159 L 41.215 39.8 A 2.097 2.097 0 0 1 43.891 36.829 L 44.21 36.444 L 42.224 34.807 A .5 .5 0 0 1 42.137 34.122 A .5 .5 0 0 1 42.825 34.064 L 44.84 35.667 L 45.149 35.274 A 2.097 2.097 0 0 1 47.5 32.039 L 47.778 31.623 L 45.631 30.202 A .5 .5 0 0 1 45.473 29.531 A .5 .5 0 0 1 46.151 29.401 L 48.322 30.784 L 48.589 30.362 A 2.097 2.097 0 0 1 50.589 26.898 L 50.821 26.456 L 48.538 25.267 A .5 .5 0 0 1 48.311 24.615 A .5 .5 0 0 1 48.972 24.416 L 51.275 25.565 L 51.497 25.116 A 2.097 2.097 0 0 1 53.123 21.463 L 53.308 20.998 L 50.913 20.055 A .5 .5 0 0 1 50.619 19.431 A .5 .5 0 0 1 51.255 19.163 L 53.667 20.065 L 53.84 19.596 A 2.097 2.097 0 0 1 55.076 15.792 L 55.211 15.311 L 52.731 14.623 A .5 .5 0 0 1 52.373 14.033 A .5 .5 0 0 1 52.978 13.701 L 55.47 14.345 L 55.593 13.861 A 2.097 2.097 0 0 1 56.425 9.949 L 56.51 9.456 L 53.97 9.031 A .5 .5 0 0 1 53.553 8.482 A .5 .5 0 0 1 54.12 8.088 L 56.666 8.468 L 56.738 7.974 A 2.097 2.097 0 0 1 57.156 3.996 L 57.188 3.497 L 54.619 3.34 A .5 .5 0 0 1 54.147 2.837 A .5 .5 0 0 1 54.669 2.386 L 57.241 2.499 L 57.26 1.999 A 2.097 2.097 0 0 1 57.26 -1.999 L 57.241 -2.499 L 54.669 -2.386 A .5 .5 0 0 1 54.147 -2.837 A .5 .5 0 0 1 54.619 -3.34 L 57.188 -3.497 L 57.156 -3.996 A 2.097 2.097 0 0 1 56.738 -7.974 L 56.666 -8.468 L 54.12 -8.088 A .5 .5 0 0 1 53.553 -8.482 A .5 .5 0 0 1 53.97 -9.031 L 56.51 -9.456 L 56.425 -9.949 A 2.097 2.097 0 0 1 55.593 -13.861 L 55.47 -14.345 L 52.978 -13.701 A .5 .5 0 0 1 52.373 -14.033 A .5 .5 0 0 1 52.731 -14.623 L 55.211 -15.311 L 55.076 -15.792 A 2.097 2.097 0 0 1 53.84 -19.596 L 53.667 -20.065 L 51.255 -19.163 A .5 .5 0 0 1 50.619 -19.431 A .5 .5 0 0 1 50.913 -20.055 L 53.308 -20.998 L 53.123 -21.463 A 2.097 2.097 0 0 1 51.497 -25.116 L 51.275 -25.565 L 48.972 -24.416 A .5 .5 0 0 1 48.311 -24.615 A .5 .5 0 0 1 48.538 -25.267 L 50.821 -26.456 L 50.589 -26.898 A 2.097 2.097 0 0 1 48.589 -30.362 L 48.322 -30.784 L 46.151 -29.401 A .5 .5 0 0 1 45.473 -29.531 A .5 .5 0 0 1 45.631 -30.202 L 47.778 -31.623 L 47.5 -32.039 A 2.097 2.097 0 0 1 45.149 -35.274 L 44.84 -35.667 L 42.825 -34.064 A .5 .5 0 0 1 42.137 -34.122 A .5 .5 0 0 1 42.224 -34.807 L 44.21 -36.444 L 43.891 -36.829 A 2.097 2.097 0 0 1 41.215 -39.8 L 40.866 -40.159 L 39.03 -38.354 A .5 .5 0 0 1 38.34 -38.34 A .5 .5 0 0 1 38.354 -39.03 L 40.159 -40.866 L 39.8 -41.215 A 2.097 2.097 0 0 1 36.829 -43.891 L 36.444 -44.21 L 34.807 -42.224 A .5 .5 0 0 1 34.122 -42.137 A .5 .5 0 0 1 34.064 -42.825 L 35.667 -44.84 L 35.274 -45.149 A 2.097 2.097 0 0 1 32.039 -47.5 L 31.623 -47.778 L 30.202 -45.631 A .5 .5 0 0 1 29.531 -45.473 A .5 .5 0 0 1 29.401 -46.151 L 30.784 -48.322 L 30.362 -48.589 A 2.097 2.097 0 0 1 26.898 -50.589 L 26.456 -50.821 L 25.267 -48.538 A .5 .5 0 0 1 24.615 -48.311 A .5 .5 0 0 1 24.416 -48.972 L 25.565 -51.275 L 25.116 -51.497 A 2.097 2.097 0 0 1 21.463 -53.123 L 20.998 -53.308 L 20.055 -50.913 A .5 .5 0 0 1 19.431 -50.619 A .5 .5 0 0 1 19.163 -51.255 L 20.065 -53.667 L 19.596 -53.84 A 2.097 2.097 0 0 1 15.792 -55.076 L 15.311 -55.211 L 14.623 -52.731 A .5 .5 0 0 1 14.033 -52.373 A .5 .5 0 0 1 13.701 -52.978 L 14.345 -55.47 L 13.861 -55.593 A 2.097 2.097 0 0 1 9.949 -56.425 L 9.456 -56.51 L 9.031 -53.97 A .5 .5 0 0 1 8.482 -53.553 A .5 .5 0 0 1 8.088 -54.12 L 8.468 -56.666 L 7.974 -56.738 A 2.097 2.097 0 0 1 3.996 -57.156 L 3.497 -57.188 L 3.34 -54.619 A .5 .5 0 0 1 2.837 -54.147 A .5 .5 0 0 1 2.386 -54.669 L 2.499 -57.241 L 1.999 -57.26 A 2.097 2.097 0 0 1 -1.999 -57.26 L -2.499 -57.241 L -2.386 -54.669 A .5 .5 0 0 1 -2.837 -54.147 A .5 .5 0 0 1 -3.34 -54.619 L -3.497 -57.188 L -3.996 -57.156 A 2.097 2.097 0 0 1 -7.974 -56.738 L -8.468 -56.666 L -8.088 -54.12 A .5 .5 0 0 1 -8.482 -53.553 A .5 .5 0 0 1 -9.031 -53.97 L -9.456 -56.51 L -9.949 -56.425 A 2.097 2.097 0 0 1 -13.861 -55.593 L -14.345 -55.47 L -13.701 -52.978 A .5 .5 0 0 1 -14.033 -52.373 A .5 .5 0 0 1 -14.623 -52.731 L -15.311 -55.211 L -15.792 -55.076 A 2.097 2.097 0 0 1 -19.596 -53.84 L -20.065 -53.667 L -19.163 -51.255 A .5 .5 0 0 1 -19.431 -50.619 A .5 .5 0 0 1 -20.055 -50.913 L -20.998 -53.308 L -21.463 -53.123 A 2.097 2.097 0 0 1 -25.116 -51.497 L -25.565 -51.275 L -24.416 -48.972 A .5 .5 0 0 1 -24.615 -48.311 A .5 .5 0 0 1 -25.267 -48.538 L -26.456 -50.821 L -26.898 -50.589 A 2.097 2.097 0 0 1 -30.362 -48.589 L -30.784 -48.322 L -29.401 -46.151 A .5 .5 0 0 1 -29.531 -45.473 A .5 .5 0 0 1 -30.202 -45.631 L -31.623 -47.778 L -32.039 -47.5 A 2.097 2.097 0 0 1 -35.274 -45.149 L -35.667 -44.84 L -34.064 -42.825 A .5 .5 0 0 1 -34.122 -42.137 A .5 .5 0 0 1 -34.807 -42.224 L -36.444 -44.21 L -36.829 -43.891 A 2.097 2.097 0 0 1 -39.8 -41.215 L -40.159 -40.866 L -38.354 -39.03 A .5 .5 0 0 1 -38.34 -38.34 A .5 .5 0 0 1 -39.03 -38.354 L -40.866 -40.159 L -41.215 -39.8 A 2.097 2.097 0 0 1 -43.891 -36.829 L -44.21 -36.444 L -42.224 -34.807 A .5 .5 0 0 1 -42.137 -34.122 A .5 .5 0 0 1 -42.825 -34.064 L -44.84 -35.667 L -45.149 -35.274 A 2.097 2.097 0 0 1 -47.5 -32.039 L -47.778 -31.623 L -45.631 -30.202 A .5 .5 0 0 1 -45.473 -29.531 A .5 .5 0 0 1 -46.151 -29.401 L -48.322 -30.784 L -48.589 -30.362 A 2.097 2.097 0 0 1 -50.589 -26.898 L -50.821 -26.456 L -48.538 -25.267 A .5 .5 0 0 1 -48.311 -24.615 A .5 .5 0 0 1 -48.972 -24.416 L -51.275 -25.565 L -51.497 -25.116 A 2.097 2.097 0 0 1 -53.123 -21.463 L -53.308 -20.998 L -50.913 -20.055 A .5 .5 0 0 1 -50.619 -19.431 A .5 .5 0 0 1 -51.255 -19.163 L -53.667 -20.065 L -53.84 -19.596 A 2.097 2.097 0 0 1 -55.076 -15.792 L -55.211 -15.311 L -52.731 -14.623 A .5 .5 0 0 1 -52.373 -14.033 A .5 .5 0 0 1 -52.978 -13.701 L -55.47 -14.345 L -55.593 -13.861 A 2.097 2.097 0 0 1 -56.425 -9.949 L -56.51 -9.456 L -53.97 -9.031 A .5 .5 0 0 1 -53.553 -8.482 A .5 .5 0 0 1 -54.12 -8.088 L -56.666 -8.468 L -56.738 -7.974 A 2.097 2.097 0 0 1 -57.156 -3.996 L -57.188 -3.497 L -54.619 -3.34 A .5 .5 0 0 1 -54.147 -2.837 A .5 .5 0 0 1 -54.669 -2.386 L -57.241 -2.499 L -57.26 -1.999 A 2.097 2.097 0 0 1 -57.26 1.999 L -57.241 2.499 L -54.669 2.386 A .5 .5 0 0 1 -54.147 2.837 A .5 .5 0 0 1 -54.619 3.34 L -57.188 3.497 L -57.156 3.996 A 2.097 2.097 0 0 1 -56.738 7.974 L -56.666 8.468 L -54.12 8.088 A .5 .5 0 0 1 -53.553 8.482 A .5 .5 0 0 1 -53.97 9.031 L -56.51 9.456 L -56.425 9.949 A 2.097 2.097 0 0 1 -55.593 13.861 L -55.47 14.345 L -52.978 13.701 A .5 .5 0 0 1 -52.373 14.033 A .5 .5 0 0 1 -52.731 14.623 L -55.211 15.311 L -55.076 15.792 A 2.097 2.097 0 0 1 -53.84 19.596 L -53.667 20.065 L -51.255 19.163 A .5 .5 0 0 1 -50.619 19.431 A .5 .5 0 0 1 -50.913 20.055 L -53.308 20.998 L -53.123 21.463 A 2.097 2.097 0 0 1 -51.497 25.116 L -51.275 25.565 L -48.972 24.416 A .5 .5 0 0 1 -48.311 24.615 A .5 .5 0 0 1 -48.538 25.267 L -50.821 26.456 L -50.589 26.898 A 2.097 2.097 0 0 1 -48.589 30.362 L -48.322 30.784 L -46.151 29.401 A .5 .5 0 0 1 -45.473 29.531 A .5 .5 0 0 1 -45.631 30.202 L -47.778 31.623 L -47.5 32.039 A 2.097 2.097 0 0 1 -45.149 35.274 L -44.84 35.667 L -42.825 34.064 A .5 .5 0 0 1 -42.137 34.122 A .5 .5 0 0 1 -42.224 34.807 L -44.21 36.444 L -43.891 36.829 A 2.097 2.097 0 0 1 -41.215 39.8 L -40.866 40.159 L -39.03 38.354 A .5 .5 0 0 1 -38.34 38.34 A .5 .5 0 0 1 -38.354 39.03 L -40.159 40.866 L -39.8 41.215 A 2.097 2.097 0 0 1 -36.829 43.891 L -36.444 44.21 L -34.807 42.224 A .5 .5 0 0 1 -34.122 42.137 A .5 .5 0 0 1 -34.064 42.825 L -35.667 44.84 L -35.274 45.149 A 2.097 2.097 0 0 1 -32.039 47.5 L -31.623 47.778 L -30.202 45.631 A .5 .5 0 0 1 -29.531 45.473 A .5 .5 0 0 1 -29.401 46.151 L -30.784 48.322 L -30.362 48.589 A 2.097 2.097 0 0 1 -26.898 50.589 L -26.456 50.821 L -25.267 48.538 A .5 .5 0 0 1 -24.615 48.311 A .5 .5 0 0 1 -24.416 48.972 L -25.565 51.275 L -25.116 51.497 A 2.097 2.097 0 0 1 -21.463 53.123 L -20.998 53.308 L -20.055 50.913 A .5 .5 0 0 1 -19.431 50.619 A .5 .5 0 0 1 -19.163 51.255 L -20.065 53.667 L -19.596 53.84 A 2.097 2.097 0 0 1 -15.792 55.076 L -15.311 55.211 L -14.623 52.731 A .5 .5 0 0 1 -14.033 52.373 A .5 .5 0 0 1 -13.701 52.978 L -14.345 55.47 L -13.861 55.593 A 2.097 2.097 0 0 1 -9.949 56.425 L -9.456 56.51 L -9.031 53.97 A .5 .5 0 0 1 -8.482 53.553 A .5 .5 0 0 1 -8.088 54.12 L -8.468 56.666 L -7.974 56.738 A 2.097 2.097 0 0 1 -3.996 57.156 L -3.497 57.188 L -3.34 54.619 A .5 .5 0 0 1 -2.837 54.147 Z M -57 -60 H 57 A 3 3 0 0 1 60 -57 V 57 A 3 3 0 0 1 57 60 H 50.5 A .5 .5 0 0 0 49.5 60 H .5 A .5 .5 0 0 0 -.5 60 H -57 A 3 3 0 0 1 -60 57 V -57 A 3 3 0 0 1 -57 -60 Z M -55.657 -44.343 A 8 8 0 0 1 -44.343 -55.657 A 58 58 0 0 0 44.343 -55.657 A 8 8 0 0 1 55.657 -44.343 A 58 58 0 0 0 55.657 44.343 A 8 8 0 0 1 44.343 55.657 A 58 58 0 0 0 -44.343 55.657 A 8 8 0 0 1 -55.657 44.343 A 58 58 0 0 0 -55.657 -44.343 Z " />' if (show_pieces == True) else ''}
<path id="pata" d="{pata.strip()}" />
</svg>
'''
 return svg

svg = build_svg()
out = '../../svg_master/patas.svg'
with open(out, 'w', encoding='utf-8') as f:
 f.write(svg)
print(out + ' WRITTEN')
